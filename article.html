<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Article – Paul Kerlin</title>

    <link rel="icon" type="image/x-icon" href="assets/img/favicon.png" />
    <!-- Font Awesome & Google Fonts (same as index) -->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />

    <!-- GitHub-like Markdown CSS (for clean MD defaults) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css" />

    <!-- Core theme CSS (includes Bootstrap) -->
    <link href="css/styles.css" rel="stylesheet" />

    <!-- Prism (syntax highlighting) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" />

    <!-- Marked (Markdown renderer) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Narrow & center ONLY on article pages while keeping site look */
        body.article-page .resume-section .resume-section-content {
            max-width: 860px;
            margin: 0 auto;
        }
        /* Smooth fade */
        .fade-slot { opacity: 0; transition: opacity 400ms ease; }
        .fade-slot.show { opacity: 1; }
        /* Meta + ToC */
        .article-sub { color: #6c757d; margin: 0 0 1rem; font-size: .95rem; }
        .toc {
            border: 1px solid #e9ecef; border-radius: .5rem;
            padding: .75rem 1rem; background: #f8f9fa; margin: 1rem 0 2rem;
        }
        .toc h6 { margin: 0 0 .5rem; font-weight: 700; color: #6c757d; }
        .toc a { text-decoration: none; }
        /* Make markdown play nice with your theme */
        .markdown-body h1, .markdown-body h2 { color: #0d6efd; }
        .markdown-body pre { border-radius: 8px; }
        .back-link { text-decoration: none; color: #0d6efd; }
        .back-link:hover { text-decoration: underline; }
        @media (prefers-color-scheme: dark) {
            .toc { background: #111827; border-color: #1f2937; }
        }
    </style>
</head>
<body id="page-top" class="article-page">
<!-- Side Nav (same structure as your index) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
    <a class="navbar-brand js-scroll-trigger" href="index.html#page-top">
        <span class="d-block d-lg-none">Paul Kerlin</span>
        <span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="assets/img/Headshot.jpg" alt="..." /></span>
    </a>
</nav>

<!-- Page Content -->
<div class="container-fluid p-0">
    <section class="resume-section" id="article">
        <div class="resume-section-content">
            <a href="index.html#articles" id="backLink" class="back-link">← Back to Articles</a>
            <h1 id="articleTitle" class="mb-1"></h1>
            <div id="articleSub" class="article-sub"></div>

            <div id="toc" class="toc" style="display:none;">
                <h6>On this page</h6>
                <nav id="tocList"></nav>
            </div>

            <!-- Rendered Markdown goes here -->
            <article id="content" class="markdown-body fade-slot"></article>
        </div>
    </section>
</div>

<!-- Bootstrap core JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Your site JS -->
<script src="js/scripts.js"></script>

<!-- Prism core + autoloader AFTER content -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"
        data-autoloader-path="https://cdn.jsdelivr.net/npm/prismjs@1/components/"></script>

<script>
    marked.setOptions({
        gfm: true,
        breaks: true,
        headerIds: true,
        mangle: false,
        smartypants: true
    });

    (function () {
        const params  = new URLSearchParams(location.search);
        let   file    = params.get("file");
        const content = document.getElementById("content");
        const titleEl = document.getElementById("articleTitle");
        const subEl   = document.getElementById("articleSub");
        const tocBox  = document.getElementById("toc");
        const tocList = document.getElementById("tocList");

        if (!file) {
            content.innerHTML = "<p>No article specified.</p>";
            content.classList.add("show");
            return;
        }

        // normalize path
        file = file.replace(/^\/+/, "").replace(/\.\./g, "");
        const url = file.split("/").map(encodeURIComponent).join("/");

        let lastModifiedText = "";

        fetch(url, { cache: "no-store" })
            .then(res => {
                if (!res.ok) throw new Error("HTTP " + res.status);
                const lm = res.headers.get("last-modified");
                if (lm) {
                    const d = new Date(lm);
                    lastModifiedText = d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
                }
                return res.text();
            })
            .then(md => {
                // --- Title extraction (first H1) ---
                const lines = md.split(/\r?\n/);
                let h1 = "";
                if (lines[0] && /^#\s+/.test(lines[0])) {
                    h1 = lines[0].replace(/^#\s+/, "").trim();
                    md = lines.slice(1).join("\n"); // remove H1 from body count
                } else {
                    h1 = decodeURIComponent(file.split("/").pop().replace(/\.md$/i, "").replace(/[-_]/g, " "));
                }
                titleEl.textContent = h1;

                // --- Estimate read time (strip code & markdown, count words) ---
                const WPM = 220; // tweak if you want
                const textForCount = md
                    .replace(/```[\s\S]*?```/g, " ")      // remove fenced code blocks
                    .replace(/`[^`]*`/g, " ")             // remove inline code
                    .replace(/!\[[^\]]*\]\([^)]+\)/g, " ")// images
                    .replace(/\[[^\]]*\]\([^)]+\)/g, " ") // links [txt](url)
                    .replace(/[#>*_~\-]+/g, " ")          // markdown symbols
                    .replace(/\s+/g, " ")
                    .trim();

                const words = textForCount ? textForCount.split(" ").length : 0;
                const mins  = Math.max(1, Math.round(words / WPM));

                // --- Subheader (date • ~X min read) ---
                subEl.textContent = lastModifiedText
                    ? `${lastModifiedText} • ~${mins} min read`
                    : `~${mins} min read`;

                // --- Render Markdown ---
                content.innerHTML = marked.parse(md);

                // --- ToC from H2/H3 ---
                const headings = content.querySelectorAll("h2, h3");
                if (headings.length) {
                    const ul = document.createElement("ul");
                    ul.style.margin = "0";
                    ul.style.paddingLeft = "1rem";
                    headings.forEach(h => {
                        if (!h.id) h.id = h.textContent.toLowerCase().trim().replace(/[^\w]+/g, "-");
                        const li = document.createElement("li");
                        li.style.listStyle = "disc";
                        if (h.tagName === "H3") li.style.marginLeft = "1rem";
                        const a = document.createElement("a");
                        a.href = "#" + h.id;
                        a.textContent = h.textContent;
                        a.style.color = "#0d6efd";
                        li.appendChild(a);
                        ul.appendChild(li);
                    });
                    tocList.innerHTML = "";
                    tocList.appendChild(ul);
                    tocBox.style.display = "";
                }

                // --- Highlight + Fade in ---
                Prism.highlightAllUnder(content);
                requestAnimationFrame(() => content.classList.add("show"));
            })
            .catch(err => {
                console.error(err);
                content.innerHTML = "<p>Could not load article.</p>";
                content.classList.add("show");
            });
    })();
</script>
<script>
    (function () {
        const back = document.getElementById('backLink');

        // Build absolute URL to index.html#articles alongside article.html
        const base = location.origin + location.pathname.replace(/[^/]*$/, '');
        let backURL = base + 'index.html#articles';

        // If your site serves index at the folder root (e.g., GitHub Pages),
        // you can also force root with:
        // backURL = location.origin + location.pathname.replace(/\/[^/]*$/, '/') + '#articles';

        // Ensure the anchor has the absolute href (optional but nice)
        back.setAttribute('href', backURL);

        back.addEventListener('click', function (e) {
            e.preventDefault();
            // Replace current history entry so you don't have to click back twice
            location.replace(backURL);
        });
    })();
</script>
</body>
</html>